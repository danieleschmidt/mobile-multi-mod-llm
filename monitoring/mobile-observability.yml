# Mobile Deployment Observability Configuration
# Enhanced monitoring for mobile AI/ML model deployments

# Mobile-specific metrics collection
mobile_metrics:
  model_performance:
    - name: inference_latency_mobile
      type: histogram
      description: "Model inference latency on mobile devices"
      labels:
        - device_type
        - os_version
        - model_version
        - task_type
      buckets: [0.005, 0.01, 0.025, 0.05, 0.1, 0.25, 0.5, 1.0, 2.5, 5.0]
    
    - name: mobile_model_accuracy
      type: gauge
      description: "Model accuracy metrics on mobile devices"
      labels:
        - device_type
        - model_version
        - dataset
        - quantization_level
    
    - name: mobile_memory_usage
      type: gauge
      description: "Memory usage during mobile inference"
      labels:
        - device_type
        - available_memory_gb
        - model_size_mb
    
    - name: mobile_battery_impact
      type: gauge
      description: "Battery consumption during inference"
      labels:
        - device_type
        - battery_level
        - charging_state
    
    - name: mobile_thermal_throttling
      type: counter
      description: "Thermal throttling events during inference"
      labels:
        - device_type
        - cpu_temperature
        - gpu_temperature

  deployment_metrics:
    - name: mobile_app_crashes
      type: counter
      description: "Mobile app crashes related to model inference"
      labels:
        - device_type
        - os_version
        - crash_reason
        - model_version
    
    - name: mobile_model_load_time
      type: histogram
      description: "Time to load model on mobile device"
      labels:
        - device_type
        - storage_type
        - model_size_mb
      buckets: [0.1, 0.5, 1.0, 2.0, 5.0, 10.0, 30.0]
    
    - name: mobile_network_usage
      type: counter
      description: "Network data usage for model updates"
      labels:
        - connection_type
        - model_version
        - update_type
    
    - name: mobile_device_compatibility
      type: gauge
      description: "Device compatibility score"
      labels:
        - device_model
        - os_version
        - hardware_features

# Grafana dashboard configuration for mobile metrics
grafana_dashboards:
  mobile_performance_overview:
    title: "Mobile Multi-Modal LLM - Performance Overview"
    panels:
      - title: "Inference Latency by Device Type"
        type: graph
        targets:
          - expr: histogram_quantile(0.95, rate(inference_latency_mobile_bucket[5m]))
            legendFormat: "{{ device_type }} - 95th percentile"
          - expr: histogram_quantile(0.50, rate(inference_latency_mobile_bucket[5m]))
            legendFormat: "{{ device_type }} - 50th percentile"
        yAxes:
          left:
            unit: "s"
            min: 0
        
      - title: "Model Accuracy Trends"
        type: graph
        targets:
          - expr: mobile_model_accuracy
            legendFormat: "{{ device_type }} - {{ model_version }}"
        yAxes:
          left:
            unit: "percent"
            min: 0
            max: 100
      
      - title: "Memory Usage Distribution"
        type: heatmap
        targets:
          - expr: mobile_memory_usage
            legendFormat: "{{ device_type }}"
        
      - title: "Battery Impact Analysis"
        type: graph
        targets:
          - expr: rate(mobile_battery_impact[1h])
            legendFormat: "{{ device_type }} - Battery drain rate"
        yAxes:
          left:
            unit: "percent"
      
      - title: "Thermal Throttling Events"
        type: stat
        targets:
          - expr: sum(rate(mobile_thermal_throttling[1h])) by (device_type)
            legendFormat: "{{ device_type }}"
        
      - title: "App Stability Metrics"
        type: graph
        targets:
          - expr: rate(mobile_app_crashes[1h])
            legendFormat: "{{ device_type }} - Crash rate"
        yAxes:
          left:
            unit: "crashes/hour"

  mobile_deployment_health:
    title: "Mobile Deployment Health"
    panels:
      - title: "Model Load Performance"
        type: graph
        targets:
          - expr: histogram_quantile(0.95, rate(mobile_model_load_time_bucket[5m]))
            legendFormat: "95th percentile load time"
        
      - title: "Device Compatibility Matrix"
        type: table
        targets:
          - expr: mobile_device_compatibility
            legendFormat: "{{ device_model }} - {{ os_version }}"
        
      - title: "Network Usage Trends"
        type: graph
        targets:
          - expr: rate(mobile_network_usage[1h])
            legendFormat: "{{ connection_type }} - {{ update_type }}"
        
      - title: "Performance by Hardware Features"
        type: graph
        targets:
          - expr: avg(inference_latency_mobile) by (device_type, hardware_features)
            legendFormat: "{{ device_type }} - {{ hardware_features }}"

# Alerting rules for mobile deployment issues
alerting_rules:
  mobile_performance_alerts:
    - alert: HighMobileInferenceLatency
      expr: histogram_quantile(0.95, rate(inference_latency_mobile_bucket[5m])) > 0.1
      for: 2m
      labels:
        severity: warning
        component: mobile-inference
      annotations:
        summary: "High inference latency detected on mobile devices"
        description: "95th percentile inference latency is {{ $value }}s on {{ $labels.device_type }}"
        runbook_url: "https://docs.company.com/runbooks/mobile-performance"
    
    - alert: MobileModelAccuracyDrop
      expr: mobile_model_accuracy < 0.85
      for: 5m
      labels:
        severity: critical
        component: mobile-model
      annotations:
        summary: "Model accuracy dropped below threshold"
        description: "Model accuracy is {{ $value }} on {{ $labels.device_type }}"
    
    - alert: HighMobileMemoryUsage
      expr: mobile_memory_usage > 0.8
      for: 3m
      labels:
        severity: warning
        component: mobile-memory
      annotations:
        summary: "High memory usage on mobile device"
        description: "Memory usage is {{ $value }}GB on {{ $labels.device_type }}"
    
    - alert: FrequentAppCrashes
      expr: rate(mobile_app_crashes[1h]) > 0.1
      for: 1m
      labels:
        severity: critical
        component: mobile-stability
      annotations:
        summary: "High crash rate detected"
        description: "Crash rate is {{ $value }} crashes/hour on {{ $labels.device_type }}"
    
    - alert: ThermalThrottlingDetected
      expr: rate(mobile_thermal_throttling[10m]) > 0
      for: 1m
      labels:
        severity: warning
        component: mobile-thermal
      annotations:
        summary: "Thermal throttling detected"
        description: "Device {{ $labels.device_type }} experiencing thermal throttling"
    
    - alert: SlowModelLoading
      expr: histogram_quantile(0.95, rate(mobile_model_load_time_bucket[5m])) > 10
      for: 2m
      labels:
        severity: warning
        component: mobile-loading
      annotations:
        summary: "Slow model loading on mobile devices"
        description: "Model load time 95th percentile is {{ $value }}s"

# Mobile-specific log aggregation patterns
log_aggregation:
  mobile_inference_logs:
    pattern: "mobile.inference.*"
    fields:
      - timestamp
      - device_id
      - device_type
      - model_version
      - task_type
      - latency_ms
      - memory_usage_mb
      - battery_level
      - temperature_celsius
      - error_message
    
  mobile_crash_logs:
    pattern: "mobile.crash.*"
    fields:
      - timestamp
      - device_id
      - device_type
      - os_version
      - app_version
      - model_version
      - stack_trace
      - memory_state
      - battery_level
    
  mobile_performance_logs:
    pattern: "mobile.performance.*"
    fields:
      - timestamp
      - device_id
      - device_type
      - benchmark_type
      - score
      - baseline_score
      - regression_detected

# Distributed tracing for mobile inference pipeline
tracing_config:
  mobile_inference_spans:
    - name: "mobile.model.load"
      tags:
        - device_type
        - model_version
        - storage_type
    
    - name: "mobile.preprocessing"
      tags:
        - input_type
        - preprocessing_time_ms
        - input_resolution
    
    - name: "mobile.inference"
      tags:
        - model_version
        - hardware_acceleration
        - quantization_level
        - batch_size
    
    - name: "mobile.postprocessing"
      tags:
        - output_format
        - postprocessing_time_ms
    
    - name: "mobile.result.delivery"
      tags:
        - delivery_method
        - result_size_bytes

# Mobile device fleet management integration
fleet_management:
  device_groups:
    - name: "flagship_devices"
      criteria:
        - ram_gb: ">= 8"
        - cpu_cores: ">= 8"
        - gpu_memory_gb: ">= 4"
      target_performance:
        inference_latency_ms: "< 10"
        accuracy_threshold: "> 0.95"
    
    - name: "mid_range_devices"
      criteria:
        - ram_gb: ">= 4"
        - cpu_cores: ">= 6"
      target_performance:
        inference_latency_ms: "< 20"
        accuracy_threshold: "> 0.90"
    
    - name: "budget_devices"
      criteria:
        - ram_gb: ">= 3"
      target_performance:
        inference_latency_ms: "< 50"
        accuracy_threshold: "> 0.85"
  
  rollout_strategy:
    canary_percentage: 5
    rollout_phases:
      - phase: "canary"
        percentage: 5
        duration_hours: 24
        success_criteria:
          - crash_rate: "< 0.01"
          - accuracy_regression: "< 0.05"
      
      - phase: "partial"
        percentage: 25
        duration_hours: 72
        success_criteria:
          - crash_rate: "< 0.005"
          - latency_regression: "< 0.1"
      
      - phase: "full"
        percentage: 100
        success_criteria:
          - user_satisfaction: "> 0.9"